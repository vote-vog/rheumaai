name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Install Expo CLI
      run: npm install -g expo-cli

    - name: Setup environment variables
      run: |
        echo "EXPO_TOKEN=$EXPO_TOKEN" >> $GITHUB_ENV
        echo "SUPABASE_URL=$SUPABASE_URL" >> $GITHUB_ENV
        echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" >> $GITHUB_ENV

    - name: Run expo prebuild
      run: npx expo prebuild --platform android

    - name: Apply CRITICAL Android fixes AFTER prebuild
      run: |
        cd apps/mobile/android
        
        # ПЕРЕЗАПИСЫВАЕМ Gradle версию на 7.6 ПОСЛЕ prebuild
        echo "distributionBase=GRADLE_USER_HOME" > gradle/wrapper/gradle-wrapper.properties
        echo "distributionPath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        echo "distributionUrl=https://services.gradle.org/distributions/gradle-7.6-all.zip" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStoreBase=GRADLE_USER_HOME" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStorePath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        
        # ФИКСИМ `harnessEnabled` в app/build.gradle
        sed -i 's/hennesEnabled/hennesEnabled.toBoolean()/g' app/build.gradle
        
        # Отключаем toolchain
        echo "android.useAndroidX=true" > gradle.properties
        echo "android.enableJetifie=true" >> gradle.properties
        echo "org.gradle.java.installations.auto-detect=false" >> gradle.properties
        echo "org.gradle.java.installations.auto-download=false" >> gradle.properties

    - name: Build Android APK
      run: |
        cd apps/mobile/android
        ./gradlew assembleRelease

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: rheumaai-apk
        path: apps/mobile/android/app/build/outputs/apk/release/*.apk
